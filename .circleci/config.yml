---
version: 2
jobs:
  test:
    working_directory: ~/project

    docker:
    - image: circleci/ruby:2.5
    - image: mysql:5.7
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_ROOT_HOST: '%'
        MYSQL_DATABASE: mysql2spatial

    steps:
    - run: gem install bundler
    - run: bundle config packagecloud.io $PACKAGECLOUD_READ_TOKEN
    - checkout
    - run: bundle install
    - run: cp ~/project/test/database-example.yml ~/project/test/database.yml
    - run: rake test
  build:
    docker:
    - image: circleci/ruby:2.5
    steps:
    - run: gem install package_cloud
    - checkout
    # Clean up any .gem files from all previous builds
    - run: rm -f *.gem
    - run: gem build $(ls *.gemspec)
    - run: package_cloud push avvo/gems $(ls *.gem)
workflows:
  version: 2
  build-workflow:
    jobs:
    - test:
        context: org-global
        filters:
          tags:
            only: /.*/
          branches:
            only: /.*/
    - build:
        requires:
        - test
        context: org-global
        filters:
          tags:
            only: /^v[0-9]+\.[0-9]+\.[0-9]+.*/
          branches:
            ignore: /.*/
